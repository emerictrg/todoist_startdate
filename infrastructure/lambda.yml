AWSTemplateFormatVersion:  "2010-09-09"
Description:  "Todoist lambda function to catch reminders"

Parameters:

  LambdaSourceBucket:
    Type: "String"
    Description:  "Bucket where the code is stored"

  LambdaSourceKey:
    Type: "String"
    Description: "Object key for the code in  the LambdaSourceBucket bucket"
  
Resources:
  
  LambdaExecutionRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Effect: "Allow"
          Principal:
            Service:
            - "lambda.amazonaws.com"
          Action:
            - "sts:AssumeRole"
      Path: "/"
      Policies:
      - PolicyName: "root"
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: "Allow"
            Action:
            - "logs:*"
            Resource: "arn:aws:logs:*:*:*"

  ReminderLambda:
    Type: "AWS::Lambda::Function"
    Properties:
      Handler: "dist/index.lambdaHandler"
      Runtime: "nodejs18.x"
      Role: !GetAtt "LambdaExecutionRole.Arn"
      Code:
        S3Bucket: !Ref "LambdaSourceBucket"
        S3Key: !Ref "LambdaSourceKey"
      Tags:
        - Key: "Application"
          Value: "Todoist start date"

  ReminderLambdaURL:
    Type: "AWS::Lambda::Url"
    Properties:
      AuthType: "NONE"
      TargetFunctionArn: !GetAtt "ReminderLambda.Arn"

  ReminderLambdaUrlPermission:
    Type: "AWS::Lambda::Permission"
    Properties:
      FunctionName: !Ref "ReminderLambda"
      Action: "lambda:InvokeFunctionUrl"
      Principal: "*"
      FunctionUrlAuthType: "NONE"
      
